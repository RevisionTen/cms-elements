<div {{ editorAttr(element, edit, 'bg-warning') }} class="{{ elementClasses(element) }}">

    {% if element.data.image is defined and element.data.image %}

        {% set hasMetaData = element.data.image is iterable and element.data.image.file is defined %}
        {% if hasMetaData %}
            {% set mimeType = element.data.image.mimeType ?? 'image/jpeg' %}
            {% set filePath = element.data.image.file %}
            {% set fileWidth = element.data.image.width ?? 500 %}
            {% set fileHeight = element.data.image.height ?? 500 %}
        {% else %}
            {% set mimeType = 'image/jpeg' %}
            {% set filePath = element.data.image %}
            {% set fileWidth = 500 %}
            {% set fileHeight = 500 %}
        {% endif %}

        {% set showOriginal = element.data.settings.showOriginal ?? false %}
        {% if showOriginal or mimeType == 'image/svg+xml' or filePath|slice(-4) == '.svg' %}
            <img class="img-fluid"
                 title="{{ element.data.title }}"
                 alt="{{ element.data.title }}"
                 src="{{ filePath }}"
                 loading="lazy"
            >
        {% else %}
            {% set width = element.data.settings.width ?? null %}
            {% set height = element.data.settings.height ?? null %}
            {% if (width and height is null) %}
                {# calculate correct size for missing height based on original ratio #}
                {% set height = (width * (fileHeight / fileWidth))|number_format(0) %}
            {% elseif (height and width is null) %}
                {# calculate correct size for missing width based on original ratio #}
                {% set width = (height * (fileWidth / fileHeight))|number_format(0) %}
            {% elseif height is null and width is null %}
                {# use original file size #}
                {% set width = fileWidth %}
                {% set height = fileHeight %}
            {% endif %}

            {% set src05xWebP = web_image(filePath).zoomCrop(((width * 0.5)|round(0)), ((height * 0.5)|round(0))) %}
            {% set src1xWebP = web_image(filePath).zoomCrop(width, height) %}
            {% set src2xWebP = web_image(filePath).zoomCrop(width * 2, height * 2) %}
            {% set src3xWebP = web_image(filePath).zoomCrop(width * 3, height * 3) %}
            {% set src4xWebP = web_image(filePath).zoomCrop(width * 4, height * 4) %}

            {% set src05x = web_image(filePath).zoomCrop(((width * 0.5)|round(0)), ((height * 0.5)|round(0))) %}
            {% set src1x = web_image(filePath).zoomCrop(width, height) %}
            {% set src2x = web_image(filePath).zoomCrop(width * 2, height * 2) %}
            {% set src3x = web_image(filePath).zoomCrop(width * 3, height * 3) %}
            {% set src4x = web_image(filePath).zoomCrop(width * 4, height * 4) %}

            {% set grayscale = element.data.settings.grayscale ?? false %}
            {% if grayscale %}
                {% set src05xWebP = src05xWebP.grayscale() %}
                {% set src1xWebP = src1xWebP.grayscale() %}
                {% set src2xWebP = src2xWebP.grayscale() %}
                {% set src3xWebP = src3xWebP.grayscale() %}
                {% set src4xWebP = src4xWebP.grayscale() %}
                {% set src05x = src05x.grayscale() %}
                {% set src1x = src1x.grayscale() %}
                {% set src2x = src2x.grayscale() %}
                {% set src3x = src3x.grayscale() %}
                {% set src4x = src4x.grayscale() %}
            {% endif %}

            {% set fixOrientation = element.data.settings.fixOrientation ?? false %}
            {% if fixOrientation %}
                {% set src05xWebP = src05xWebP.fixOrientation() %}
                {% set src1xWebP = src1xWebP.fixOrientation() %}
                {% set src2xWebP = src2xWebP.fixOrientation() %}
                {% set src3xWebP = src3xWebP.fixOrientation() %}
                {% set src4xWebP = src4xWebP.fixOrientation() %}
                {% set src05x = src05x.fixOrientation() %}
                {% set src1x = src1x.fixOrientation() %}
                {% set src2x = src2x.fixOrientation() %}
                {% set src3x = src3x.fixOrientation() %}
                {% set src4x = src4x.fixOrientation() %}
            {% endif %}

            {% set heightPercentage = ((height / width) * 100)|number_format(2) %}
            <div class="position-relative w-100" style="padding-bottom: {{ heightPercentage }}%;">
                <picture class="lozad position-absolute w-100" title="{{ element.data.title }}" data-iesrc="{{ src1x }}" data-alt="{{ element.data.title }}">
                    <source type="image/webp"
                            class="img-fluid"
                            width="{{ width }}"
                            height="{{ height }}"
                            srcset="
                                {{ src05xWebP.webp() }} {{ (width * 0.5)|round(0) }}w,
                                {{ src1xWebP.webp() }} {{ width }}w,
                                {{ src2xWebP.webp() }} {{ width * 2 }}w,
                                {{ src3xWebP.webp() }} {{ width * 3 }}w,
                                {{ src4xWebP.webp() }} {{ width * 4 }}w
                            "
                    >
                    <source type="{{ mimeType }}"
                            class="img-fluid"
                            width="{{ width }}"
                            height="{{ height }}"
                            srcset="
                                {{ src05x }} {{ (width * 0.5)|round(0) }}w,
                                {{ src1x }} {{ width }}w,
                                {{ src2x }} {{ width * 2 }}w,
                                {{ src3x }} {{ width * 3 }}w,
                                {{ src4x }} {{ width * 4 }}w
                            "
                    >
                    <noscript>
                        <img
                                class="img-fluid"
                                width="{{ width }}"
                                height="{{ height }}"
                                title="{{ element.data.title }}"
                                alt="{{ element.data.title }}"
                                src="{{ src1x }}"
                                srcset="
                                    {{ src05x }} {{ (width * 0.5)|round(0) }}w,
                                    {{ src1x }} {{ width }}w,
                                    {{ src2x }} {{ width * 2 }}w,
                                    {{ src3x }} {{ width * 3 }}w,
                                    {{ src4x }} {{ width * 4 }}w
                                "
                                loading="lazy"
                        >
                    </noscript>
                </picture>
            </div>
        {% endif %}
    {% endif %}
</div>
